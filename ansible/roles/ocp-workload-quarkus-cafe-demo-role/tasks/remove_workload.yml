---
# Remove quarkus-cafe-customermock
# ------------------------------------------
- name: Delete quarkus-cafe-customermock instance
  command: "oc delete -f {{ config_location }}/quarkus-cafe-customermock.yaml"
  ignore_errors: yes

# Remove quarkus-cafe-web instance
# ------------------------------------------
- name: Delete quarkus-cafe-web instance
  command: "oc delete -f {{ config_location }}/quarkus-cafe-web.yaml"
  ignore_errors: yes

# Remove quarkus-cafe-kitchen 
# ------------------------------------------
- name: Delete quarkus-cafe-kitchen instance
  command: "oc delete -f {{ config_location }}/quarkus-cafe-kitchen.yaml"
  ignore_errors: yes

# Remove mongodb
# ------------------------------------------
- name: Delete mongodb instance
  command: "oc delete all --selector app=mongodb"
  ignore_errors: yes

# Remove mongodb secert
# ------------------------------------------
- name: Delete mongodb secret
  command: "oc delete secret mongodb"
  ignore_errors: yes

# Remove quarkus-cafe-core workload
# ------------------------------------------
- name: Delete quarkus-cafe-core instance
  command: "oc delete -f {{ config_location }}/quarkus-cafe-core.yaml"
  ignore_errors: yes

# Remove quarkus-cafe-barista workload
# ------------------------------------------
- name: Delete quarkus-cafe-barista instance
  command: "oc delete -f {{ config_location }}/quarkus-cafe-barista.yaml"
  ignore_errors: yes

# Remove AMQ workload
# ------------------------------------------
- name: Remove kafka topics
  command: "oc delete -f {{ config_location }}/amq-kafka-topics.yaml"
  ignore_errors: yes

- name: Remove kafka instance
  command: "oc delete -f {{ config_location }}/amq-kafka-instance.yaml"
  ignore_errors: yes

- name: Waiting for  kafka instances to be deleted
  shell: |
    set -o pipefail && oc get pods | grep Running | grep {{ kafka_cluster_name }} | wc -l
  register: install_status
  until: "'No resources found' in install_status.stderr or '0' in install_status.stdout"
  retries: 60
  delay: 15
  ignore_errors: yes
  args:
    executable: /bin/bash

- name: Remove AMQ Subscription
  command: "oc delete -f {{ config_location }}/amq-sub.yaml"
  ignore_errors: yes

- name: Remove AMQ
  command: "oc delete csv {{ amqstartingCSV }} -n {{ project_namespace }}"
  ignore_errors: yes

# Remove Quarkus cafe project
# ------------------------------------------
- name: Delete Quarkus Cafe app project
  command: "oc delete project {{ project_namespace }}"

# Leave this as the last task in the playbook.
# --------------------------------------------
- name: remove_workload tasks complete
  debug:
    msg: "Remove Workload tasks completed successfully."
  when: not silent|bool
